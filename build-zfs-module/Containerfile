# This example builds the zfs module following the work done at:
# https://github.com/skateman/atomic-zfs
FROM fedora:37

#We can't use the `uname -r` as it will pick up the host kernel version 
RUN dnf install -y kernel
RUN sudo dnf groupinstall -y "Development Tools"

RUN rpm -qa kernel --queryformat '%{VERSION}-%{RELEASE}.%{ARCH}' > ./kernel-version.txt

RUN dnf install -y automake libtool gettext autoconf libblkid-devel libtirpc-devel libuuid-devel kernel-modules-$(cat ./kernel-version.txt) kernel-devel-$(cat ./kernel-version.txt)


RUN curl -L -O https://github.com/openzfs/zfs/releases/download/zfs-2.1.6/zfs-2.1.6.tar.gz && tar xvzf zfs-2.1.6.tar.gz
RUN cd zfs-2.1.6 && sh autogen.sh && ./configure && make -s -j$(nproc)
RUN cd zfs-2.1.6 && sudo make install && sudo ldconfig
